#!/bin/bash -e
USAGE="vp-auto-test buildvmdir"

timeout=60
buildvm=$1

ls $buildvm/shared/clovr-*.runtests > /tmp/vp.newbuilds

for $n in `cat /tmp/vp.newbuilds`
do
    dname=`dirname $n`
    bname=`basename $n .runtests`
    echo "Running image $dname/$bname"
    #Modify start up process to install hudson
    mkdir $dname/$bname/shared/user-scripts
    chmod 777 $dname/$bname/shared/user-scripts
    ln -s /opt/vappio-install/recipes/hudson.sh $dname/$bname/shared/user-scripts/01-installhudson
    echo "#\!/bin/bash" > $dname/$bname/shared/user-scripts/02-starthudson
    echo "/etc/init.d/hudson start" > $dname/$bname/shared/user-scripts/02-starthudson
    chmod a+rx $dname/$bname/shared/user-scripts/01-starthudson
    #TODO - set 24hr shutdown
    
    #Boot the image
    nipaddr=`~/vp-launch-headless $dname/$bname vmware`
    sleep 30 #wait for hudson to start
    
    #Launch the tests
    curl --silent http://$nipaddr:$hudsonport > /dev/null
    if [ $? != 0 ]
    then
	echo "Hudson not found at $nipaddr:$hudsonport"
    else
	for $t in `cat $n`
	do
	    echo "curl --silent http://$nipaddr:8888/job/$t/build"
	done
    fi
done
